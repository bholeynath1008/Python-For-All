### ğŸ“– Core Concepts
4. [The 6-Step Connection Flow](#the-6-step-connection-flow)
5. [Visual Architecture](#visual-architecture)
6. [Key Concepts Explained](#key-concepts-explained)

## The 6-Step Connection Flow

### Complete Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    APPLICATION STARTUP                       â”‚
â”‚                                                              â”‚
â”‚  1. Create Engine         â†’ Connects to DATABASE_URL        â”‚
â”‚  2. Create Base           â†’ Parent class for models         â”‚
â”‚  3. Define Models         â†’ Inherit from Base               â”‚
â”‚  4. Create SessionLocal   â†’ Bound to Engine                 â”‚
â”‚  5. Create Tables         â†’ Base.metadata.create_all()      â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     FOR EACH REQUEST                         â”‚
â”‚                                                              â”‚
â”‚  6. Dependency Injection:                                    â”‚
â”‚     a. SessionLocal() creates new session                    â”‚
â”‚     b. Yield session to route function                       â”‚
â”‚     c. Route uses session: db.query(...)                     â”‚
â”‚     d. Finally: session.close()                              â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Visual Architecture

### Complete Binding Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         APPLICATION                             â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚  DATABASE_URL   â”‚           â”‚   Base (Meta)   â”‚            â”‚
â”‚  â”‚"postgresql://..." â”‚           â”‚declarative_base()â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚           â”‚                             â”‚                     â”‚
â”‚           â–¼ BIND                        â”‚ INHERIT             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚     ENGINE      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚    MODELS       â”‚            â”‚
â”‚  â”‚ create_engine() â”‚           â”‚ Product, User   â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚           â”‚                                                    â”‚
â”‚           â”‚ BIND via sessionmaker(bind=engine)                â”‚
â”‚           â–¼                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
â”‚  â”‚  SessionLocal   â”‚â”€â”€Factoryâ”€â”€â–ºâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  sessionmaker() â”‚            â”‚ FOR EACH REQUEST:        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚ 1. SessionLocal() â†’ db   â”‚ â”‚
â”‚                                 â”‚ 2. Use in route          â”‚ â”‚
â”‚                                 â”‚ 3. db.close()            â”‚ â”‚
â”‚                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Key Concepts Explained

### What is `db` in Route Functions?

```python
@app.get("/products")
def get_products(db: Session = Depends(get_database_session)):
    # âŒ db is NOT "the database"
    # âœ… db IS "a temporary session with the database"
    
    # db = Communication channel
    # db = Created fresh for THIS request
    # db = Automatically closed after response
    # db = Tracks changes until you commit()
    
    return db.query(Product).all()
```

### Session Lifecycle

```python
# Session Creation
db = SessionLocal()  # New session created

# Session Usage
product = db.query(Product).filter(Product.id == 1).first()  # Read
product.price = 99.99  # Modify (tracked, not saved)
db.add(new_product)  # Add (tracked, not saved)

# Session Commit
db.commit()  # Save all changes permanently

# Session Rollback (on error)
try:
    db.query(...)
    db.commit()
except:
    db.rollback()  # Undo all tracked changes

# Session Close
db.close()  # ALWAYS close to release connection
```

### Why Temporary Sessions Per Request?

**Bad (Shared Session):**
```python
# âŒ GLOBAL SESSION (NEVER DO THIS!)
global_db = SessionLocal()  # Created once

@app.get("/products")
def get_products():
    # Multiple concurrent requests share same session
    # Changes from one request affect another
    # Data corruption!
    return global_db.query(Product).all()
```

**Good (Temporary Session):**
```python
# âœ… NEW SESSION PER REQUEST
@app.get("/products")
def get_products(db: Session = Depends(get_database_session)):
    # Request 1 gets Session A (isolated)
    # Request 2 gets Session B (isolated)
    # No interference between requests
    return db.query(Product).all()
```

---

## File Structure Reference

### Recommended Project Structure

```
fastapi-project/
â”‚
â”œâ”€â”€ ğŸ“„ main.py                          # FastAPI app & startup
â”‚
â”œâ”€â”€ ğŸ“ database/
â”‚   â”œâ”€â”€ ğŸ“„ __init__.py
â”‚   â”œâ”€â”€ ğŸ“„ engine.py                    # Engine configuration
â”‚   â””â”€â”€ ğŸ“„ session.py                   # SessionLocal factory
â”‚
â”œâ”€â”€ ğŸ“ models/
â”‚   â”œâ”€â”€ ğŸ“„ __init__.py
â”‚   â”œâ”€â”€ ğŸ“„ base.py                      # Base = declarative_base()
â”‚   â”œâ”€â”€ ğŸ“„ product.py                   # Product model
â”‚   â””â”€â”€ ğŸ“„ user.py                      # User model
â”‚
â”œâ”€â”€ ğŸ“ schemas/
â”‚   â”œâ”€â”€ ğŸ“„ __init__.py
â”‚   â”œâ”€â”€ ğŸ“„ product.py                   # Pydantic schemas
â”‚   â””â”€â”€ ğŸ“„ user.py                      # Pydantic schemas
â”‚
â”œâ”€â”€ ğŸ“ dependencies/
â”‚   â”œâ”€â”€ ğŸ“„ __init__.py
â”‚   â””â”€â”€ ğŸ“„ database.py                  # get_database_session()
â”‚
â”œâ”€â”€ ğŸ“ api/
â”‚   â””â”€â”€ ğŸ“ routes/
â”‚       â”œâ”€â”€ ğŸ“„ __init__.py
â”‚       â”œâ”€â”€ ğŸ“„ products.py              # Product endpoints
â”‚       â””â”€â”€ ğŸ“„ users.py                 # User endpoints
â”‚
â”œâ”€â”€ ğŸ“„ .env                              # Environment variables
â”œâ”€â”€ ğŸ“„ .env.example                      # Environment template
â””â”€â”€ ğŸ“„ requirements.txt                  # Dependencies
```

### File Contents Quick Reference

**database/engine.py:**
```python
from sqlalchemy import create_engine
import os

DATABASE_URL = os.getenv("DATABASE_URL")
engine = create_engine(DATABASE_URL, pool_pre_ping=True)
```

**models/base.py:**
```python
from sqlalchemy.ext.declarative import declarative_base
Base = declarative_base()
```

**database/session.py:**
```python
from sqlalchemy.orm import sessionmaker
from .engine import engine

SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
```

**dependencies/database.py:**
```python
from database.session import SessionLocal

def get_database_session():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()
```

**main.py:**
```python
from fastapi import FastAPI
from models.base import Base
from database.engine import engine

app = FastAPI()

@app.on_event("startup")
def startup():
    Base.metadata.create_all(bind=engine)
```

---
