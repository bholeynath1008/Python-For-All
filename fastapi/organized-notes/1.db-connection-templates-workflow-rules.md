# üìö FastAPI + SQLAlchemy Database Connection Guide
### This contains `guide`, `basic rules` and `templates` for sql connection.
## üìã Table of Contents

### üöÄ Getting Started
1. [Quick Start Guide](#quick-start-guide)
2. [Detailed Step-by-Step Guide](#detailed-step-by-step-guide)
3. [File Structure Reference](#file-structure-reference)


### Simple installation: For Advance setup follow: [Installation Guide](#installation-guide)
```python
# Install FastAPI, SQLAlchemy, Postgres Driver (psycopg2)
pip install fastapi sqlalchemy psycopg2
pip install python-dotenv
```

## Quick Start Guide

### The Golden Rule
**One Engine ‚Üí One SessionLocal Factory ‚Üí Many Temporary Sessions (one per request)**

### Minimum Required Steps and Templates (Follow this Template if confusion:)
```python
# 1. Create Engine (Once)
from sqlalchemy import create_engine
url = "postgresql://postgres:your_password@localhost:5432/your_database"
# user -> postgres, default Port -> 5432, default db -> postgres
engine = create_engine(url)

# 2. Create Base (Once)
from sqlalchemy.ext.declarative import declarative_base
Base = declarative_base()

# 3. Define Models (Once per table)
from sqlalchemy import Column, Integer, String
class User(Base):
    __tablename__ = "users"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String(100), nullable=False)

# 4. Create SessionLocal Factory (Once)
from sqlalchemy.orm import sessionmaker
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

# 5. Create Tables (Once, at startup)
Base.metadata.create_all(bind=engine)

# 6. Dependency Function (Use in routes)
def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

# 7. In Routes (Every endpoint)
from fastapi import Depends
from sqlalchemy.orm import Session

@app.get("/users")
def get_users(db: Session = Depends(get_db)):
    return db.query(User).all()
```

---

## Detailed Step-by-Step Guide

### STEP 1: Create Engine (The Connection Pool Manager)

**File: `database/engine.py`**

```python
from sqlalchemy import create_engine
import os

# Database URL format: dialect://username:password@host:port/database
# PostgreSQL: postgresql://user:pass@localhost:5432/mydb
# MySQL: mysql://user:pass@localhost:3306/mydb
# SQLite: sqlite:///./database.db or sqlite:///:memory:

DATABASE_URL = os.getenv("DATABASE_URL", "postgresql://postgres:password@localhost:5432/fastapi_db")

# Create the engine - ONE per application
engine = create_engine(
    DATABASE_URL,
    
    # Connection Pool Settings
    pool_size=20,              # Maximum 20 connections in pool
    max_overflow=0,            # No extra connections beyond pool_size
    pool_timeout=30,           # Wait 30 seconds for available connection
    pool_recycle=1800,         # Recycle connections after 30 minutes
    
    # Safety & Performance
    pool_pre_ping=True,        # Test connection before using (prevents stale connections)
    
    # Debugging (Development only!)
    echo=True,                 # Log all SQL queries to console
    echo_pool="debug",         # Log connection pool events
    hide_parameters=False,     # Show query parameters in logs
)
```

**What the Engine Does:**
- Manages a pool of database connections (reuses connections for efficiency)
- Translates Python code to database-specific SQL
- Handles connection lifecycle (open, close, recycle)
- **Critical:** Create only ONE engine per application

**Key Parameters Explained:**

| Parameter | Purpose | Recommendation |
|-----------|---------|----------------|
| `pool_size` | Max connections kept open | 20 for most apps |
| `pool_pre_ping` | Test connection before use | Always `True` |
| `pool_recycle` | Refresh old connections | 1800 (30 min) |
| `echo` | Log SQL queries | `True` in dev, `False` in prod |

---

### STEP 2: Create Base Model (The Parent Class)

**File: `models/base.py`**

```python
from sqlalchemy.ext.declarative import declarative_base

# Create the base class - ALL models inherit from this
Base = declarative_base()

# This Base tracks:
# - All table definitions
# - Relationships between tables
# - Metadata for creating/dropping tables
```

**Why Base?**
- Provides a registry of all your models/tables
- Enables `Base.metadata.create_all()` to create all tables at once
- Manages relationships between models
- Every model class MUST inherit from this Base

---

### STEP 3: Define Models (The Table Definitions)

**File: `models/product.py`**

```python
from sqlalchemy import Column, Integer, String, Float, Index
from .base import Base

class Product(Base):
    __tablename__ = "products"  # REQUIRED: actual table name in database
    
    # Primary Key - Required for every table
    id = Column(Integer, primary_key=True, index=True)
    # primary_key=True: Unique identifier, usually auto-incrementing
    # index=True: Creates database index for fast lookups
    
    # String columns
    name = Column(String(100), nullable=False, index=True)
    # String(100): Maximum 100 characters
    # nullable=False: Required field (NOT NULL in SQL)
    # index=True: Fast searches by name
    
    description = Column(String(500))  # Optional field
    
    # Numeric columns
    price = Column(Float, nullable=False)
    quantity = Column(Integer, default=0)
    # default=0: Value if not provided
    
    # Advanced: Composite indexes
    __table_args__ = (
        Index('idx_name_price', 'name', 'price'),  # Index on multiple columns
    )
```

**When to Use `index=True`:**

‚úÖ **Always index:**
- Primary keys (`id`)
- Foreign keys
- Frequently searched columns (`email`, `username`)
- Columns in WHERE clauses
- Columns used in JOIN operations

‚ùå **Don't index:**
- Rarely searched columns
- Columns with few unique values (e.g., `is_active`)
- Large text fields (unless using full-text search)

**Performance Impact:**
- Indexes speed up reads (SELECT) by 10-100x
- Indexes slow down writes (INSERT/UPDATE) by ~10-20%
- Use strategically based on your query patterns

---

### STEP 4: Create SessionLocal Factory

**File: `database/session.py`**

```python
from sqlalchemy.orm import sessionmaker, Session
from .engine import engine

# SessionLocal is a FACTORY, not a session
# Calling SessionLocal() creates a NEW session
SessionLocal = sessionmaker(
    autocommit=False,    # We control when to commit
    autoflush=False,     # We control when to flush
    bind=engine,         # Connect to our engine
    expire_on_commit=True,  # Clear cache after commit
    class_=Session,      # Type of session to create
)
```

**Critical Settings Explained:**

#### `autocommit=False` (RECOMMENDED)
```python
# With autocommit=False (SAFE - Recommended)
def transfer_money(db: Session):
    account1.balance -= 100  # Tracked, not saved yet
    account2.balance += 100  # Tracked, not saved yet
    
    try:
        db.commit()  # Both saved together (atomic)
    except:
        db.rollback()  # Neither saved (all-or-nothing)

# With autocommit=True (DANGEROUS - Not recommended)
def transfer_money(db: Session):
    account1.balance -= 100  # IMMEDIATELY SAVED!
    # If crash here, money deducted but not added!
    account2.balance += 100  # Never reaches this line
```

#### `autoflush=False` (RECOMMENDED)
```python
# With autoflush=False (FASTER - Recommended)
db.query(User).filter(User.id == 1).first()
# Executes immediately without checking for pending changes

# With autoflush=True (SLOWER)
db.query(User).filter(User.id == 1).first()
# First flushes ALL pending changes, then executes query
# Unnecessary overhead for most queries
```

**What is Flush vs Commit?**
- **Flush**: Send Python changes to database (but don't save permanently)
- **Commit**: Save changes permanently to database
- Usually you just need commit; flush is handled automatically when needed

---

### STEP 5: Create Tables in Database

**File: `main.py`**

```python
from fastapi import FastAPI
from models.base import Base
from database.engine import engine
from models import product, user  # Import all models!

app = FastAPI()

# Create tables at startup (development)
@app.on_event("startup")
def create_tables():
    Base.metadata.create_all(bind=engine)
    # Creates ALL tables defined in models
    # Safe to run multiple times (won't recreate existing tables)
    # Does NOT delete or modify existing data

# Alternative: Run once manually
if __name__ == "__main__":
    Base.metadata.create_all(bind=engine)
```

**When to Run:**
- ‚úÖ First time setting up database
- ‚úÖ After adding new models/tables
- ‚úÖ After changing table structure (in development)
- ‚ùå Every request (too slow!)
- ‚ö†Ô∏è Production: Use migrations (Alembic) instead

---

### STEP 6: Dependency Injection (The Session Manager)

**File: `dependencies/database.py`**

```python
from database.session import SessionLocal
from sqlalchemy.orm import Session
from typing import Generator

def get_database_session() -> Generator[Session, None, None]:
    """
    Dependency that creates a new database session for each request.
    
    Flow:
    1. Create new session (SessionLocal())
    2. Yield session to route function
    3. Route function uses session
    4. Finally block closes session (even if error occurs)
    """
    db_session = SessionLocal()  # Create NEW session
    
    try:
        yield db_session  # Give session to route function
        # FastAPI pauses here while route executes
        
    except Exception as e:
        # On error: rollback any uncommitted changes
        db_session.rollback()
        raise e
        
    finally:
        # ALWAYS close session to release connection
        db_session.close()
        # Critical: Returns connection to pool for reuse
```

**How It Works Per Request:**

```
User Request
    ‚Üì
FastAPI calls get_database_session()
    ‚Üì
Creates NEW session: SessionLocal()
    ‚Üì
Yields session to route function
    ‚Üì
Route executes: db.query(...)
    ‚Üì
Route returns response
    ‚Üì
FINALLY block executes: db_session.close()
    ‚Üì
Connection returned to pool
    ‚Üì
Response sent to user
```

---

## Installation Guide

### Required Installations

#### 1. **Core Dependencies**
```bash
# Install FastAPI and SQLAlchemy
pip install fastapi sqlalchemy uvicorn[standard]
```

#### 2. **Database-Specific Drivers**

**For PostgreSQL:**
```bash
# Install PostgreSQL driver
pip install psycopg2-binary

# Alternative (compiled version, faster but requires build tools)
pip install psycopg2
```

**For MySQL/MariaDB:**
```bash
# Install MySQL driver
pip install pymysql

# Alternative (faster, recommended)
pip install mysqlclient
```

**For SQLite:**
```bash
# No additional installation needed!
# SQLite comes built-in with Python
```

**For Microsoft SQL Server:**
```bash
# Install SQL Server driver
pip install pyodbc
```

**For Oracle:**
```bash
# Install Oracle driver
pip install cx_Oracle
```

#### 3. **Additional Utilities**
```bash
# Environment variable management
pip install python-dotenv

# Data validation (included with FastAPI but good to specify)
pip install pydantic

# Database migrations (optional but recommended)
pip install alembic
```

#### 4. **Complete requirements.txt**

**For PostgreSQL Project:**
```txt
# requirements.txt
fastapi==0.109.0
uvicorn[standard]==0.27.0
sqlalchemy==2.0.25
psycopg2-binary==2.9.9
python-dotenv==1.0.0
pydantic==2.5.3
alembic==1.13.1
```

**For MySQL Project:**
```txt
# requirements.txt
fastapi==0.109.0
uvicorn[standard]==0.27.0
sqlalchemy==2.0.25
pymysql==1.1.0
python-dotenv==1.0.0
pydantic==2.5.3
alembic==1.13.1
```

**For SQLite Project (Development/Testing):**
```txt
# requirements.txt
fastapi==0.109.0
uvicorn[standard]==0.27.0
sqlalchemy==2.0.25
python-dotenv==1.0.0
pydantic==2.5.3
alembic==1.13.1
```

#### 5. **Install All Dependencies**
```bash
# Install from requirements.txt
pip install -r requirements.txt

# Or install everything at once
pip install fastapi uvicorn[standard] sqlalchemy psycopg2-binary python-dotenv pydantic alembic
```

---

### Database Server Installation

#### **PostgreSQL Installation**

**On Ubuntu/Debian:**
```bash
# Update package list
sudo apt update

# Install PostgreSQL
sudo apt install postgresql postgresql-contrib

# Start PostgreSQL service
sudo systemctl start postgresql
sudo systemctl enable postgresql

# Check status
sudo systemctl status postgresql
```

**On macOS:**
```bash
# Using Homebrew
brew install postgresql@15

# Start PostgreSQL
brew services start postgresql@15

# Or use Postgres.app (GUI)
# Download from: https://postgresapp.com/
```

**On Windows:**
```bash
# Download installer from:
# https://www.postgresql.org/download/windows/

# Or use Docker:
docker run --name postgres-db -e POSTGRES_PASSWORD=password -p 5432:5432 -d postgres:15
```

**Create Database:**
```bash
# Switch to postgres user (Linux/Mac)
sudo -u postgres psql

# Or connect directly
psql -U postgres

# Inside psql:
CREATE DATABASE fastapi_db;
CREATE USER fastapi_user WITH PASSWORD 'your_password';
GRANT ALL PRIVILEGES ON DATABASE fastapi_db TO fastapi_user;

# Exit
\q
```

#### **MySQL Installation**

**On Ubuntu/Debian:**
```bash
# Update package list
sudo apt update

# Install MySQL
sudo apt install mysql-server

# Secure installation
sudo mysql_secure_installation

# Start MySQL
sudo systemctl start mysql
sudo systemctl enable mysql
```

**On macOS:**
```bash
# Using Homebrew
brew install mysql

# Start MySQL
brew services start mysql

# Secure installation
mysql_secure_installation
```

**On Windows:**
```bash
# Download installer from:
# https://dev.mysql.com/downloads/installer/

# Or use Docker:
docker run --name mysql-db -e MYSQL_ROOT_PASSWORD=password -p 3306:3306 -d mysql:8
```

**Create Database:**
```sql
# Connect to MySQL
mysql -u root -p

# Inside MySQL:
CREATE DATABASE fastapi_db;
CREATE USER 'fastapi_user'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON fastapi_db.* TO 'fastapi_user'@'localhost';
FLUSH PRIVILEGES;

# Exit
exit;
```

#### **SQLite Installation**

```bash
# SQLite comes pre-installed with Python!
# No separate installation needed

# Verify installation
python -c "import sqlite3; print(sqlite3.sqlite_version)"

# Database file will be created automatically when you run your app
```

---

### Database Connection Strings

#### **Connection String Format**
```
dialect+driver://username:password@host:port/database
```

#### **PostgreSQL**
```python
# Local PostgreSQL
DATABASE_URL = "postgresql://fastapi_user:password@localhost:5432/fastapi_db"

# PostgreSQL with psycopg2 (explicit driver)
DATABASE_URL = "postgresql+psycopg2://user:password@localhost:5432/fastapi_db"

# Remote PostgreSQL (Heroku, AWS RDS, etc.)
DATABASE_URL = "postgresql://user:password@hostname.region.rds.amazonaws.com:5432/dbname"

# PostgreSQL with SSL
DATABASE_URL = "postgresql://user:password@host:5432/db?sslmode=require"
```

#### **MySQL/MariaDB**
```python
# Local MySQL
DATABASE_URL = "mysql://fastapi_user:password@localhost:3306/fastapi_db"

# MySQL with PyMySQL (explicit driver)
DATABASE_URL = "mysql+pymysql://user:password@localhost:3306/fastapi_db"

# MySQL with mysqlclient
DATABASE_URL = "mysql+mysqldb://user:password@localhost:3306/fastapi_db"

# MySQL with charset
DATABASE_URL = "mysql://user:password@localhost:3306/db?charset=utf8mb4"
```

#### **SQLite**
```python
# SQLite file database (relative path)
DATABASE_URL = "sqlite:///./fastapi.db"

# SQLite file database (absolute path)
DATABASE_URL = "sqlite:////absolute/path/to/fastapi.db"

# SQLite in-memory database (testing)
DATABASE_URL = "sqlite:///:memory:"

# Windows path
DATABASE_URL = "sqlite:///C:/path/to/fastapi.db"
```

#### **Microsoft SQL Server**
```python
# SQL Server with pyodbc
DATABASE_URL = "mssql+pyodbc://user:password@host:1433/database?driver=ODBC+Driver+17+for+SQL+Server"

# SQL Server with Windows Authentication
DATABASE_URL = "mssql+pyodbc://host/database?trusted_connection=yes&driver=ODBC+Driver+17+for+SQL+Server"
```

#### **Oracle**
```python
# Oracle with cx_Oracle
DATABASE_URL = "oracle+cx_oracle://user:password@host:1521/?service_name=ORCL"
```

---

### Docker Setup (Optional but Recommended)

#### **PostgreSQL with Docker**
```bash
# Create and run PostgreSQL container
docker run --name fastapi-postgres \
  -e POSTGRES_USER=fastapi_user \
  -e POSTGRES_PASSWORD=your_password \
  -e POSTGRES_DB=fastapi_db \
  -p 5432:5432 \
  -v postgres_data:/var/lib/postgresql/data \
  -d postgres:15

# Connection string
DATABASE_URL="postgresql://fastapi_user:your_password@localhost:5432/fastapi_db"
```

#### **MySQL with Docker**
```bash
# Create and run MySQL container
docker run --name fastapi-mysql \
  -e MYSQL_ROOT_PASSWORD=root_password \
  -e MYSQL_DATABASE=fastapi_db \
  -e MYSQL_USER=fastapi_user \
  -e MYSQL_PASSWORD=your_password \
  -p 3306:3306 \
  -v mysql_data:/var/lib/mysql \
  -d mysql:8

# Connection string
DATABASE_URL="mysql://fastapi_user:your_password@localhost:3306/fastapi_db"
```

#### **Docker Compose Setup**
```yaml
# docker-compose.yml
version: '3.8'

services:
  postgres:
    image: postgres:15
    container_name: fastapi-postgres
    environment:
      POSTGRES_USER: fastapi_user
      POSTGRES_PASSWORD: your_password
      POSTGRES_DB: fastapi_db
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U fastapi_user"]
      interval: 10s
      timeout: 5s
      retries: 5

  fastapi:
    build: .
    container_name: fastapi-app
    environment:
      DATABASE_URL: postgresql://fastapi_user:your_password@postgres:5432/fastapi_db
    ports:
      - "8000:8000"
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - .:/app

volumes:
  postgres_data:
```

```bash
# Start services
docker-compose up -d

# Stop services
docker-compose down

# View logs
docker-compose logs -f
```

---

### Verification Steps

#### **1. Test Database Connection**
```python
# test_connection.py
from sqlalchemy import create_engine, text
import os

DATABASE_URL = os.getenv("DATABASE_URL", "postgresql://user:password@localhost:5432/fastapi_db")

try:
    engine = create_engine(DATABASE_URL)
    with engine.connect() as connection:
        result = connection.execute(text("SELECT 1"))
        print("‚úÖ Database connection successful!")
        print(f"Result: {result.scalar()}")
except Exception as e:
    print(f"‚ùå Database connection failed: {e}")
```

```bash
# Run test
python test_connection.py
```

#### **2. Verify Python Packages**
```bash
# Check installed packages
pip list | grep -E "fastapi|sqlalchemy|psycopg2|uvicorn"

# Expected output:
# fastapi              0.109.0
# sqlalchemy           2.0.25
# psycopg2-binary      2.9.9
# uvicorn              0.27.0
```

#### **3. Test FastAPI Server**
```bash
# Start server
uvicorn main:app --reload

# Should see:
# INFO:     Uvicorn running on http://127.0.0.1:8000
# INFO:     Application startup complete.
```

---

### Troubleshooting Installation Issues

#### **PostgreSQL Driver Issues**

**Error: `pg_config executable not found`**
```bash
# Ubuntu/Debian
sudo apt-get install libpq-dev python3-dev

# macOS
brew install postgresql

# Then reinstall
pip install psycopg2
```

**Error: `psycopg2 not found`**
```bash
# Use binary version (easier)
pip uninstall psycopg2
pip install psycopg2-binary
```

#### **MySQL Driver Issues**

**Error: `mysql_config not found`**
```bash
# Ubuntu/Debian
sudo apt-get install libmysqlclient-dev python3-dev

# macOS
brew install mysql

# Then reinstall
pip install mysqlclient
```

**Alternative: Use PyMySQL (pure Python, no compilation)**
```bash
pip install pymysql
```

```python
# Use in connection string
DATABASE_URL = "mysql+pymysql://user:password@localhost:3306/db"
```

#### **SQLite Issues**

**Error: `unable to open database file`**
```python
# Ensure directory exists
import os
os.makedirs("./database", exist_ok=True)

# Use absolute path
DATABASE_URL = "sqlite:///./database/fastapi.db"
```

#### **Connection Issues**

**Error: `could not connect to server`**
```bash
# Check if database is running
# PostgreSQL
sudo systemctl status postgresql

# MySQL
sudo systemctl status mysql

# Check port
netstat -tuln | grep 5432  # PostgreSQL
netstat -tuln | grep 3306  # MySQL
```

**Error: `password authentication failed`**
```bash
# Reset PostgreSQL password
sudo -u postgres psql
ALTER USER postgres PASSWORD 'newpassword';

# Reset MySQL password
sudo mysql
ALTER USER 'root'@'localhost' IDENTIFIED BY 'newpassword';
FLUSH PRIVILEGES;
```

---
from sqlalchemy.ext.declarative import declarative_base
Base = declarative_base()

# 3Ô∏è‚É£ MODEL (Define tables)
from sqlalchemy
